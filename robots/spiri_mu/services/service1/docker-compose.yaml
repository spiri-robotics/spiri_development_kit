x-spiri-sdk-doc: |
  Runs the core services for a simulated Spiri Mu  

x-spiri-sdk-autostart: True

services:
  ardupilot:
    image: git.spirirobotics.com/spiri/ardupilot:spiri-master
    command:
      - /bin/bash
      - -c
      - |
        ./Tools/autotest/sim_vehicle.py -v ${ARDUPILOT_VEHICLE} --no-rebuild \
        --no-mavproxy --enable-dds --sysid ${DRONE_SYS_ID} \
    stdin_open: true
    tty: true
    ports:
      - $SERIAL0_PORT:$SERIAL0_PORT/tcp
    expose:
      - $SERIAL0_PORT
      - $SITL_PORT
    networks:
      - spiri-mu-net

  mavproxy:
    image: git.spirirobotics.com/spiri/services-mavproxy:main
    command: >
      mavproxy.py --non-interactive
      --master tcp:ardupilot:$SERIAL0_PORT
      --out udpout:mavros2:$MAVROS2_PORT
      --out udpout:0.0.0.0:18761
      --sitl ardupilot:$SITL_PORT
      --out tcpin:0.0.0.0:$GCS_PORT      
      --out udpout:0.0.0.0:$GCS_PORT
      --out udpout:$HOST_IP:$GCS_PORT
    ports:
      - $GCS_PORT:$GCS_PORT/tcp
    expose:
      - $SERIAL0_PORT
    restart: always
    networks:
      - spiri-mu-net

  mavros2:
    image: git.spirirobotics.com/spiri/services-ros2-mavros:main
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    command: ros2 launch mavros apm.launch fcu_url:="udp://0.0.0.0:$MAVROS2_PORT@:14555" namespace:="$ROBOT_NAME" tgt_system:="$DRONE_SYS_ID"
    expose:
      - $MAVROS2_PORT
    restart: always
    depends_on:
      ardupilot:
        condition: service_started
      mavproxy:
        condition: service_started
    deploy:
      resources:
        limits:
          # cpus: '0.01'
          memory: 200M
    ulimits:
      nofile:
        soft: 1024
        hard: 524288
    networks:
      - spiri-mu-net

networks:
  spiri-mu-net:
    driver: bridge